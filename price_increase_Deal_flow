// 1. Helper for Date Parsing
function parseHubSpotDate(timestamp) {
    if (!timestamp || isNaN(timestamp)) return null;
    return new Date(parseInt(timestamp));
}

// 2. Helper for API Calls
async function callHubSpot(url, method, body = null) {
    const res = await fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${inputData.hubspotToken}`
        },
        body: body ? JSON.stringify(body) : null
    });
    const data = await res.json();
    if (!res.ok) throw new Error(`HS API Error: ${JSON.stringify(data)}`);
    return data;
}

// Logic
return (async () => {
    try {
        // Use a direct count of how many deals to create
        // If you pass "2" in inputData.terms, we will create 2 deals.
        const billingCycles = parseInt(inputData.terms); 
        const percent = parseFloat(inputData.percentIncrease) / 100;
        const masterId = inputData.originalDealId;
        const companyId = inputData.companyId;
        const startDate = parseHubSpotDate(inputData.startDate);
        const dealNameBase = inputData.originalDealName;

        if (!startDate) throw new Error("Start Date is missing or invalid.");
        if (isNaN(billingCycles) || billingCycles < 1) return { message: "No billing cycles specified." };

        // A. GET ORIGINAL LINE ITEMS
        const assocData = await callHubSpot(`https://api.hubapi.com/crm/v3/objects/deals/${masterId}/associations/line_items`, 'GET');
        
        if (!assocData.results || assocData.results.length === 0) {
            return { message: "No Line Items found on master deal." };
        }

        const lineItemDetails = await callHubSpot(`https://api.hubapi.com/crm/v3/objects/line_items/batch/read`, 'POST', {
            properties: ["name", "quantity", "amount", "hs_product_id"],
            inputs: assocData.results.map(item => ({ id: item.id }))
        });

        // Current state for compounding (Net Prices)
        let productStates = lineItemDetails.results.map(item => ({
            id: item.properties.hs_product_id,
            name: item.properties.name,
            totalAmount: parseFloat(item.properties.amount || 0)
        }));

        let createdDeals = [];

        // B. THE LOOP
        // If billingCycles = 2, this will run for i=1 and i=2
        for (let i = 1; i <= billingCycles; i++) {
            
            // Calculate Anniversary Date (Start Date + i years)
            let annDate = new Date(startDate);
            annDate.setFullYear(annDate.getFullYear() + i);
            const dateStr = annDate.toISOString().split('T')[0];
            
            let yearTotalDelta = 0;
            let deltaLineItems = [];

            // Update States & Calculate Delta (Compounding)
            productStates = productStates.map(p => {
                const delta = p.totalAmount * percent;
                const nextYearTotal = p.totalAmount + delta;
                yearTotalDelta += delta;

                deltaLineItems.push({
                    properties: {
                        name: `Increase: ${p.name}`,
                        quantity: "1",
                        price: delta.toFixed(2), 
                        hs_product_id: p.id
                    }
                });
                return { ...p, totalAmount: nextYearTotal };
            });

            // C. CREATE DEAL
            const newDeal = await callHubSpot('https://api.hubapi.com/crm/v3/objects/deals', 'POST', {
                properties: {
                    dealname: `${dealNameBase} - Renewal - Year ${i} Increase`,
                    amount: yearTotalDelta.toFixed(2),
                    pipeline: inputData.pipelineId,
                    dealstage: inputData.dealStageId,
                    closedate: dateStr,
                    contract_term_start_date: dateStr,
                    renewal_type: "Upsell",
                    renewal_deal_id: "masterId",
                    overarching_upsell_type: "Contract Price Increase"
                }
            });

            // D. ASSOCIATE COMPANY & MASTER DEAL
            if (companyId) {
                await callHubSpot('https://api.hubapi.com/crm/v4/associations/deals/companies/batch/create', 'POST', {
                    inputs: [{ from: { id: newDeal.id }, to: { id: companyId }, types: [{ associationCategory: "HUBSPOT_DEFINED", associationTypeId: 341 }] }]
                });
            }
            await callHubSpot('https://api.hubapi.com/crm/v4/associations/deals/deals/batch/create', 'POST', {
                inputs: [{ from: { id: newDeal.id }, to: { id: masterId }, types: [{ associationCategory: "HUBSPOT_DEFINED", associationTypeId: 451 }] }]
            });

            // E. CREATE AND ATTACH LINE ITEMS
            const batchLI = await callHubSpot('https://api.hubapi.com/crm/v3/objects/line_items/batch/create', 'POST', { inputs: deltaLineItems });
            await callHubSpot('https://api.hubapi.com/crm/v4/associations/deals/line_items/batch/create', 'POST', {
                inputs: batchLI.results.map(li => ({
                    from: { id: newDeal.id },
                    to: { id: li.id },
                    types: [{ associationCategory: "HUBSPOT_DEFINED", associationTypeId: 19 }]
                }))
            });

            createdDeals.push({ id: newDeal.id, name: `${dealNameBase} - Year ${i}`, date: dateStr });
        }

        return { success: true, createdDeals };

    } catch (err) {
        throw new Error(err.message);
    }
})();
