// Parse HubSpot timestamp (milliseconds) into a Date
function parseHubSpotDate(timestamp) {
    if (!timestamp || isNaN(timestamp)) {
        return null;
    }
    return new Date(parseInt(timestamp));
}

const terms = parseInt(inputData.terms);
const percentIncrease = parseFloat(inputData.percentIncrease);
const startDate = parseHubSpotDate(inputData.startDate); // HubSpot timestamp
const originalAmount = parseFloat(inputData.amount);
const pipelineId = inputData.pipelineId;
const dealStageId = inputData.dealStageId;
const originalDealName = inputData.originalDealName;
const companyId = inputData.companyId; // Passed from Zap input
const masterDealId = inputData.originalDealId; // Passed from Zap input
const authToken = inputData.hubspotToken;

if (!startDate) {
    throw new Error(`Invalid start date: ${inputData.startDate}`);
}

const hubspotAPI = 'https://api.hubapi.com/crm/v3/objects/deals';

// Create a new deal in HubSpot
async function createDeal(dealName, amount, startDate, closeDate) {
    const body = {
        properties: {
            dealname: dealName,
            amount: amount.toFixed(2),
            pipeline: pipelineId,
            dealstage: dealStageId,
            contract_term_start_date: startDate.toISOString().split('T')[0], // YYYY-MM-DD
            closedate: closeDate.toISOString().split('T')[0],
            renewal_type: "Upsell",
            overarching_upsell_type: "Contract Price Increase",
            associated_company_id: companyId,
            renewal_deal_id: masterDealId
        }
    };

    const response = await fetch(hubspotAPI, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(body)
    });

    if (!response.ok) {
        const error = await response.text();
        throw new Error(`Error creating deal: ${error}`);
    }

    return await response.json();
}

// Create association between objects
async function createAssociation(fromId, toId, fromObject, toObject, type) {
    const url = `https://api.hubapi.com/crm/v4/associations/${fromObject}/${toObject}/batch/create`;
    const body = {
        inputs: [
            {
                from: { id: fromId },
                to: { id: toId },
                type: type
            }
        ]
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const error = await response.text();
            console.log(`Association failed: ${error}`);
        }
    } catch (e) {
        console.log(`Association error: ${e.message}`);
    }
}

// âœ… Main Logic
return (async () => {
    let results = [];
    let currentStart = new Date(startDate);

    // Flat increase calculation
    const increasedAmount = originalAmount + (originalAmount * (percentIncrease / 100));

    for (let i = 1; i <= terms; i++) {
        // Add 1 year to the current start date
        let newStart = new Date(currentStart);
        newStart.setFullYear(newStart.getFullYear() + 1);

        // Close date = same as start date
        let newClose = new Date(newStart);

        // New naming convention
        const dealName = `${originalDealName} - Year ${i} Increase`;

        // Create deal
        const newDeal = await createDeal(dealName, increasedAmount, newStart, newClose);

        // Create associations
        if (companyId) {
            await createAssociation(newDeal.id, companyId, "deals", "companies", 341);
        }
        if (masterDealId) {
            await createAssociation(newDeal.id, masterDealId, "deals", "deals", 451);
        }

        // Collect results for Zapier output
        results.push({
            id: newDeal.id,
            name: dealName,
            startDate: newStart.toISOString().split('T')[0],
            closeDate: newClose.toISOString().split('T')[0],
            amount: increasedAmount
        });

        // Prepare for next loop
        currentStart = newStart;
    }

    return { createdDeals: results };
})();
